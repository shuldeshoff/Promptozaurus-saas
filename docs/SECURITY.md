# Безопасность и приватность данных

## Обзор

Этот документ объясняет, как PromptyFlow обрабатывает, хранит и защищает данные пользователей. Информация предназначена для потенциальных клиентов и технических специалистов, которым важно понимать меры безопасности.

---

## Что мы храним

### 1. Данные проектов (промпты и контекст)

**Формат хранения:**
- Данные хранятся в PostgreSQL базе данных
- Используется JSONB формат для гибкой структуры
- Включает: названия проектов, блоки контекста, промпты, настройки

**Пример структуры:**
```json
{
 "project": {
 "id": "uuid",
 "name": "Мой проект",
 "data": {
 "contextBlocks": [...],
 "promptBlocks": [...]
 }
 }
}
```

**Статус шифрования:** Не шифруются
- Данные хранятся в открытом виде в базе данных
- Доступны администраторам БД и бэкенд-серверу
- Защищены на уровне доступа к серверу

**Почему так:**
- Необходим быстрый доступ для поиска (PostgreSQL full-text search)
- Нужна возможность индексирования
- Типично для большинства SaaS приложений (Notion, Trello, Asana)

---

### 2. API ключи к AI провайдерам

**Формат хранения:**
- Хранятся в таблице `api_keys` в PostgreSQL
- Провайдеры: OpenAI, Anthropic, Google Gemini, xAI Grok, OpenRouter

**Статус шифрования:** Полностью зашифрованы
- Алгоритм: **AES-256-GCM**
- Ключ шифрования: 32-byte ключ из переменной окружения `ENCRYPTION_KEY`
- IV (Initialization Vector): уникальный 16-byte для каждого ключа
- Auth Tag: 16-byte для проверки целостности

**Формат в БД:**
```
{iv}:{encryptedData}:{authTag}
```

**Пример:**
```
3a2b1c...:{зашифрованный ключ}:d4e5f6...
```

**Процесс:**
1. Пользователь вводит API ключ в интерфейсе
2. Backend шифрует ключ с помощью AES-256-GCM
3. Сохраняет зашифрованную версию в БД
4. При использовании расшифровывает ключ в памяти
5. Ключ никогда не возвращается в API responses

---

### 3. Учетные данные пользователей

**Что хранится:**
- Google ID (для OAuth аутентификации)
- Email адрес
- Имя пользователя
- URL аватара
- Дата регистрации и последнего входа

**Статус шифрования:** Не шифруются
- Email и имя в открытом виде
- Google ID используется для идентификации

**Почему так:**
- Необходим для поиска пользователей по email
- Используется для отправки уведомлений
- Стандартная практика для OAuth приложений

**Пароли:** 
- Не хранятся вообще
- Используется Google OAuth 2.0
- Пользователь авторизуется через Google
- Мы получаем только токен доступа

---

## Кто может видеть данные

### 1. Владелец данных (пользователь)

 **Полный доступ:**
- Видит все свои проекты
- Видит все свои промпты и контекст
- Может экспортировать данные
- Может удалить данные в любой момент

---

### 2. Администраторы PromptyFlow

 **Технический доступ:**

**Что мы МОЖЕМ видеть:**
- Все данные проектов (промпты, контекст)
- Email адреса пользователей
- Имена пользователей
- Статистику использования

**Что мы НЕ МОЖЕМ видеть:**
- API ключи к AI провайдерам (они зашифрованы)
- Пароли (их нет, используется OAuth)

**Когда мы смотрим данные:**
- **Техническая поддержка:** при обращении пользователя с проблемой
- **Отладка багов:** для воспроизведения и исправления ошибок
- **Анализ производительности:** для оптимизации работы системы
- **Юридические запросы:** по требованию правоохранительных органов

**Наша политика:**
- Мы НЕ читаем данные без необходимости
- Доступ имеют только технические специалисты
- Все действия логируются
- Соблюдаем конфиденциальность

---

### 3. AI провайдеры (OpenAI, Anthropic, и др.)

 **При отправке запросов:**

**Что они получают:**
- Текст промпта, который вы отправляете
- Контекст, который вы выбрали
- Ваш API ключ (расшифрованный)

**Что они НЕ получают:**
- Другие ваши проекты
- Ваш email
- Другие промпты, которые вы не отправляли

**Важно:**
- Каждый провайдер имеет свою политику хранения данных
- OpenAI: не использует API запросы для обучения моделей (с марта 2023)
- Anthropic: аналогичная политика
- Рекомендуем ознакомиться с политикой каждого провайдера

---

### 4. Другие пользователи

 **Не имеют доступа:**
- Ваши проекты приватные
- Никто, кроме вас, не может их видеть
- Нет публичных проектов (пока)

**Будущий функционал:**
- Планируется шеринг проектов между пользователями
- Будут разные уровни доступа (view/edit)
- Вы сможете контролировать, кому даете доступ

---

## Меры безопасности

### 1. Аутентификация

 **Google OAuth 2.0**
- Надежная система авторизации от Google
- Не храним пароли пользователей
- Используем JWT токены (срок действия: 15 минут)
- Refresh tokens для обновления доступа (7 дней)

### 2. Шифрование данных в передаче

 **HTTPS/TLS**
- Все данные передаются по защищенному соединению
- Используется TLS 1.2/1.3
- Сертификат от Let's Encrypt
- Автоматическое обновление сертификатов

### 3. Шифрование API ключей

 **AES-256-GCM**
- Военный стандарт шифрования
- Уникальный IV для каждого ключа
- Auth Tag для проверки целостности
- Ключ шифрования хранится в переменных окружения, не в коде

### 4. База данных

 **PostgreSQL безопасность**
- Доступ только через закрытую сеть
- Пароли для подключения
- Регулярные бэкапы
- Логирование всех операций

### 5. Backend безопасность

 **Защита на уровне кода**
- SQL Injection: защита через Prisma ORM (параметризованные запросы)
- XSS: React автоматически экранирует JSX
- CORS: настроен белый список доменов
- Rate Limiting: 100 запросов/минуту на пользователя
- Input Validation: проверка всех входных данных с помощью Zod

### 6. Инфраструктура

 **Серверная безопасность**
- Firewall (UFW) с закрытыми портами
- Fail2ban для защиты от брутфорса
- SSH доступ только по ключам
- Автоматические обновления безопасности
- PM2 для мониторинга процессов

---

## Как это сравнивается с другими сервисами

### Notion

**Что хранится:**
- Контент страниц шифруется при передаче (HTTPS)
- Контент НЕ шифруется в БД (как у нас)
- Администраторы могут видеть данные
- Используется для индексирования и поиска

**Вывод:** Аналогично нашему подходу

---

### Trello / Asana

**Что хранится:**
- Данные карточек/задач не шифруются в БД
- HTTPS для передачи
- OAuth для аутентификации

**Вывод:** Аналогично нашему подходу

---

### 1Password / Bitwarden (Password Managers)

**Что хранится:**
- Все данные зашифрованы end-to-end
- Master password известен только пользователю
- Администраторы НЕ могут видеть данные
- Нет полнотекстового поиска на сервере

**Вывод:** Более строгая модель, но:
- Сложнее в реализации
- Невозможен серверный поиск
- Требует master password
- Подходит для паролей, не для документов

---

### Google Docs / Microsoft Office 365

**Что хранится:**
- Контент документов не зашифрован end-to-end
- HTTPS для передачи
- Администраторы могут видеть данные
- Используется для поиска и сотрудничества

**Вывод:** Аналогично нашему подходу

---

## Почему не используется полное шифрование БД

### Модель безопасности: Defense in Depth (Многоуровневая защита)

Мы используем подход **"Defense in Depth"** (эшелонированная оборона), где безопасность обеспечивается множеством слоев защиты, а не только шифрованием данных в БД.

### Слои безопасности в PromptyFlow

**1. Физический уровень**
- Сервер находится в защищенном дата-центре
- Физический доступ только у авторизованного персонала
- Видеонаблюдение и контроль доступа

**2. Сетевой уровень**
- Firewall (UFW) блокирует все порты кроме 80/443
- Fail2ban защищает от брутфорса
- DDoS защита на уровне провайдера
- Закрытая внутренняя сеть для БД

**3. Уровень доступа к инфраструктуре**
- SSH доступ только по ключам (пароли отключены)
- Доступ только с белого списка IP адресов
- VPN для администраторов при удаленном доступе
- Sudo права только у ограниченного числа специалистов
- Все действия логируются

**4. Уровень базы данных**
- PostgreSQL доступен только из локальной сети (не из интернета)
- Аутентификация по паролю для подключений
- Row Level Security через ORM (Prisma)
- Логирование всех запросов
- Регулярные аудиты доступа

**5. Уровень приложения**
- JWT токены с коротким сроком действия (15 минут)
- OAuth 2.0 через Google (не храним пароли)
- Rate limiting (100 запросов/минуту)
- Input validation (Zod)
- CORS белый список доменов

**6. Уровень транспорта**
- HTTPS/TLS 1.2/1.3 для всех соединений
- Сертификаты от Let's Encrypt
- HTTP Strict Transport Security (HSTS)
- Perfect Forward Secrecy

**7. Критичные данные**
- API ключи: AES-256-GCM шифрование
- Ключ шифрования в переменных окружения
- Ключи никогда не возвращаются в API

---

### Почему полное шифрование БД создает избыточные сложности

#### 1. Технические ограничения

**Невозможен серверный поиск:**
```
Без шифрования:
SELECT * FROM projects WHERE name LIKE '%анализ%'
️ Время: 5-10ms (с индексами)

С end-to-end шифрованием:
1. Загрузить ВСЕ проекты на клиент
2. Расшифровать каждый проект локально
3. Поиск в памяти клиента
️ Время: 2-5 секунд (для 1000 проектов)
 Трафик: 10-50 MB данных
```

**Full-text search невозможен:**
- GIN индексы PostgreSQL не работают с зашифрованными данными
- Наша оптимизация поиска (700x ускорение) становится бесполезной
- Пользователь получает медленный и неудобный интерфейс

#### 2. Performance overhead

**Шифрование/расшифрование:**
```
Открытие проекта:
- Без E2EE: 1 SQL запрос, ~10ms
- С E2EE: 1 SQL запрос + расшифровка на клиенте, ~100-200ms

Поиск по 1000 проектам:
- Без E2EE: PostgreSQL full-text search, ~5ms
- С E2EE: загрузка всех проектов + расшифровка, ~5000ms
```

**Расход батареи:**
- Постоянное шифрование/расшифрование на мобильных устройствах
- Быстрая разрядка батареи
- Нагрев устройства

#### 3. Сложность для пользователя

**Управление ключами:**
- Пользователь должен помнить master password
- Потеря пароля = потеря ВСЕХ данных навсегда
- Нет возможности восстановления (даже мы не сможем помочь)
- Сложность синхронизации между устройствами

**Проблема "Я забыл пароль":**
```
Google Docs: "Войдите через Google" 
1Password: "Потеряны все данные навсегда" 
```

#### 4. Невозможность расширенных функций

**Что становится невозможным:**
- Серверный full-text search
- Автоматическая категоризация промптов
- Рекомендации похожих промптов
- Анализ использования (для улучшения UX)
- Совместная работа в реальном времени
- Публичные шаблоны/библиотеки

---

### Когда нужно полное шифрование: примеры из других индустрий

#### Платежные системы (PCI DSS)

**Stripe, PayPal - хранение карточных данных:**

```
Что хранится: номер карты, CVV, срок действия
Регуляция: PCI DSS Level 1 (самый строгий)

Требования:
- Шифрование карточных данных в БД (AES-256)
- Токенизация для recurring платежей
- HSM (Hardware Security Module) для ключей
- Отдельная сегментированная сеть
- Ежегодный аудит PCI DSS ($50,000+)
- Penetration testing каждые 3 месяца
```

**Почему нужно:**
- Прямой финансовый ущерб при утечке
- Жесткое регулирование (штрафы от $5,000 до $500,000/месяц)
- Международные требования (PCI DSS обязателен)
- Высокий интерес хакеров (можно украсть деньги)

**Наш случай:**
- Промпты не имеют прямой финансовой ценности для хакеров
- Нет регулирования уровня PCI DSS
- Утечка не приводит к прямым финансовым потерям пользователей

---

#### Медицинские данные (HIPAA)

**Epic Systems, Cerner - электронные медицинские карты:**

```
Что хранится: диагнозы, рецепты, история болезни
Регуляция: HIPAA (США), GDPR (ЕС)

Требования:
- Шифрование PHI (Protected Health Information)
- Audit trail для каждого доступа
- Де-идентификация для аналитики
- Business Associate Agreements
- Штраф за утечку: $100-$50,000 за запись
```

**Почему нужно:**
- Персональная медицинская информация (чувствительные данные)
- Жесткое регулирование (HIPAA, GDPR)
- Дискриминация работодателей/страховых
- Репутационный ущерб

**Наш случай:**
- Промпты не являются персональными медицинскими данными
- Нет регулирования уровня HIPAA
- Пользователи сами контролируют, что хранить

---

#### Мессенджеры с E2EE

**WhatsApp, Signal - личные сообщения:**

```
Что хранится: приватные переписки
Модель угроз: правительственная слежка, массовая прослушка

Реализация:
- Signal Protocol (E2EE)
- Ключи генерируются на устройстве
- Сервер видит только метаданные (кто кому, когда)
- Невозможен поиск на сервере

Компромиссы:
 Нет облачного бэкапа (или бэкап не зашифрован)
 Нет полнотекстового поиска в облаке
 Нет синхронизации истории между устройствами (Signal)
 Сложная настройка безопасного бэкапа
```

**Почему нужно:**
- Защита от массовой слежки
- Политические активисты, журналисты
- Личные приватные разговоры
- Модель угроз: государство

**Наш случай:**
- Промпты для работы с AI, не личная переписка
- Модель угроз: не государственная слежка
- Пользователям нужен удобный поиск и синхронизация

---

### Сравнение моделей безопасности

| Критерий | Платежи (PCI DSS) | Медицина (HIPAA) | Промпты (мы) |
|----------|-------------------|------------------|--------------|
| **Чувствительность данных** | Критическая (деньги) | Критическая (здоровье) | Низкая (рабочие данные) |
| **Регулирование** | Обязательное (PCI DSS) | Обязательное (HIPAA) | Нет |
| **Штрафы за утечку** | $500K+/месяц | $50K/запись | Репутация |
| **Интерес хакеров** | Очень высокий | Высокий | Низкий |
| **Финансовый ущерб** | Прямой | Косвенный | Минимальный |
| **Шифрование в БД** | Обязательно | Рекомендуется | Избыточно |
| **E2EE** | Не требуется | Опционально | Опционально |
| **Поиск в БД** | Не нужен | Нужен (диагностика) | Критически важен |
| **Overhead приемлем** | Да (высокая маржа) | Да (здоровье важнее) | Нет (конкурентный рынок) |

---

### Наша модель безопасности: оптимальный баланс

**Что мы защищаем максимально:**
- API ключи к AI провайдерам (AES-256-GCM)
 - Высокая ценность (можно потратить деньги пользователя)
 - Невозможен поиск (нет необходимости)
 - Минимальный overhead (расшифровываем раз в 1 час)

**Что защищаем многоуровневой моделью:**
- Промпты и контекст (Defense in Depth)
 - 7 слоев защиты (сеть, доступ, БД, приложение, транспорт)
 - VPN для администраторов
 - Логирование всех действий
 - Регулярные аудиты
 - Минимальные привилегии (Principle of Least Privilege)

**Результат:**
- Безопасность на уровне индустрии (Notion, Google Docs, Trello)
- Быстрая работа (full-text search за 5ms)
- Удобство для пользователей (нет master password)
- Возможность восстановления доступа
- Доступная цена (нет overhead на шифрование)

---

### Для особо чувствительных данных

**Если у вас действительно чувствительные промпты:**

1. **Используйте локальные инструменты:**
 - Запускайте AI локально (LM Studio, Ollama)
 - Храните промпты в зашифрованных файлах
 - Используйте VeraCrypt, BitLocker

2. **Self-hosted версия (будущее):**
 - Разверните PromptyFlow на своем сервере
 - Полный контроль над данными
 - Можете внедрить database encryption
 - Документация в разделе DEPLOYMENT.md

3. **E2EE режим (roadmap v2.0):**
 - Опциональный режим для отдельных проектов
 - Пользователь выбирает: удобство или максимальная безопасность
 - Предупреждение о ограничениях (нет поиска, нет восстановления)

---

### Итог: почему наш подход правильный

**Безопасность - это баланс:**
- Security vs Usability vs Performance vs Cost

**Мы выбрали:**
- Многоуровневая защита (Defense in Depth)
- Шифрование критичных данных (API ключи)
- Industry best practices (как у лидеров рынка)
- Прозрачность (честно рассказываем о модели)

**Результат:**
- Безопасность достаточна для 99% use cases
- Производительность не страдает
- UX на высоком уровне
- Доступная цена для пользователей

**Если вам нужно больше:**
- Self-hosted опция (полный контроль)
- E2EE режим (в разработке)
- Консультация по индивидуальным требованиям

---

## Рекомендации для клиентов

### Для максимальной безопасности:

1. **Не храните чувствительные данные в промптах**
 - Избегайте паролей, ключей доступа, персональных данных
 - Используйте абстрактные примеры

2. **Используйте разные API ключи**
 - Создайте отдельные ключи для PromptyFlow
 - Ограничьте права ключей (если провайдер позволяет)
 - Регулярно ротируйте ключи

3. **Экспортируйте данные регулярно**
 - Делайте бэкапы своих проектов
 - Храните копии локально
 - Используйте функцию экспорта в JSON

4. **Следите за доступом**
 - Используйте надежный пароль для Google аккаунта
 - Включите 2FA в Google
 - Выходите из аккаунта на общих компьютерах

5. **Удаляйте неиспользуемые данные**
 - Регулярно чистите старые проекты
 - Удаляйте неактуальные промпты
 - Это уменьшает поверхность атаки

---

## End-to-End шифрование (будущее)

### Что это такое?

**End-to-End Encryption (E2EE):**
- Данные шифруются на устройстве пользователя
- Сервер хранит зашифрованные данные
- Только пользователь имеет ключ расшифровки
- Даже администраторы не могут прочитать данные

### Почему мы не используем сейчас?

**Технические ограничения:**
- Невозможен серверный полнотекстовый поиск
- Сложнее делиться проектами между пользователями
- Требует управления ключами (сложно для пользователей)
- Если потеряли ключ = потеряли все данные

**Но мы планируем:**
- Опциональный E2EE для особо чувствительных проектов
- Пользователь сможет выбрать: удобство или максимальная безопасность
- Реализация в roadmap для версии 2.0

---

## Compliance и стандарты

### Текущий статус

**Что мы соблюдаем:**
- HTTPS/TLS для всех подключений
- OAuth 2.0 для аутентификации
- AES-256-GCM для критичных данных (API ключи)
- Best practices разработки (OWASP Top 10)
- Регулярные бэкапы
- Логирование доступа

**Что планируется:**
- GDPR compliance (для работы в ЕС)
- SOC 2 Type II (для корпоративных клиентов)
- ISO 27001 (информационная безопасность)

---

## Права пользователей (GDPR-готовность)

### Right to Access (Право на доступ)

 Вы можете:
- Просмотреть все свои данные в любое время
- Экспортировать проекты в JSON
- Получить копию всех данных по запросу

### Right to Rectification (Право на исправление)

 Вы можете:
- Изменить любые данные в любое время
- Обновить профиль
- Исправить ошибки в проектах

### Right to Erasure (Право на удаление)

 Вы можете:
- Удалить любой проект
- Удалить свой аккаунт полностью
- Все данные будут удалены каскадно (projects, templates, API keys)

### Right to Data Portability (Право на переносимость)

 Вы можете:
- Экспортировать данные в JSON формате
- Импортировать данные обратно
- Перенести данные в другой сервис

---

## Что делать при утечке данных

### Если вы считаете, что ваши данные скомпрометированы:

1. **Немедленно:**
 - Измените API ключи у всех AI провайдеров
 - Измените пароль Google аккаунта
 - Выйдите из всех устройств

2. **Свяжитесь с нами:**
 - Email: security@promptyflow.com
 - Мы расследуем инцидент
 - Предоставим детали, если была утечка

3. **Мониторьте:**
 - Проверьте использование API ключей у провайдеров
 - Следите за неожиданными запросами
 - Проверьте логи активности (если доступны)

### Наша процедура при утечке:

1. **Уведомление:** 
 - Уведомим всех затронутых пользователей в течение 72 часов
 - Email + уведомление в приложении

2. **Расследование:**
 - Определим масштаб утечки
 - Найдем причину
 - Устраним уязвимость

3. **Отчет:**
 - Публичный post-mortem анализ
 - Меры по предотвращению
 - Обновления безопасности

---

## Контакты по безопасности

### Сообщить об уязвимости

**Email:** security@promptyflow.com

**Мы ценим ответственное раскрытие:**
- Сообщите нам приватно перед публикацией
- Дайте нам время на исправление (обычно 90 дней)
- Мы публично поблагодарим вас (если хотите)

**Bug Bounty:**
- Пока нет формальной программы
- Но мы благодарны за сообщения о багах
- Рассматриваем вознаграждение для критичных находок

---

## FAQ

**Q: Можете ли вы прочитать мои промпты?**
A: Технически да, так как данные не зашифрованы end-to-end. Но мы не читаем их без необходимости (техподдержка, отладка).

**Q: Можете ли вы увидеть мои API ключи?**
A: Нет, они зашифрованы AES-256-GCM. Мы можем только расшифровать их для отправки запросов к AI.

**Q: Что произойдет, если вы закроетесь?**
A: Мы уведомим за 30 дней. Вы сможете экспортировать все данные. Мы опубликуем инструкции для self-hosting.

**Q: Используете ли вы наши данные для обучения моделей?**
A: Нет, мы не обучаем никакие модели. Мы только предоставляем инструмент для работы с AI.

**Q: Передаете ли вы данные третьим лицам?**
A: Только AI провайдерам, когда вы отправляете запрос. Больше никому.

**Q: Где физически хранятся данные?**
A: На серверах в [указать регион]. Для корпоративных клиентов возможен выбор региона.

**Q: Как часто делаются бэкапы?**
A: Автоматические бэкапы каждые 24 часа. Хранятся 30 дней. Для критичных данных - continuous backup.

---

## Итоговая таблица безопасности

| Данные | Шифрование в БД | Шифрование при передаче | Доступ админов | Best Practice |
|--------|-----------------|------------------------|----------------|---------------|
| **Проекты (промпты/контекст)** | Нет | HTTPS/TLS | Да | Стандарт для SaaS |
| **API ключи** | AES-256-GCM | HTTPS/TLS | Нет (зашифровано) | Максимальная защита |
| **Email/имя** | Нет | HTTPS/TLS | Да | Стандарт для OAuth |
| **Пароли** | N/A (не хранятся) | N/A | N/A | OAuth 2.0 |

---

## Заключение

**Наш подход к безопасности:**

 **Прозрачность:** Мы честно рассказываем, что и как храним

 **Баланс:** Безопасность vs Удобство vs Функциональность

 **Стандарты:** Используем industry best practices

 **Развитие:** Постоянно улучшаем меры безопасности

**Если у вас есть вопросы или опасения:**
- Email: security@promptyflow.com
- Мы открыты к диалогу
- Ваша безопасность - наш приоритет

---

**Последнее обновление:** 05.12.2025 
**Версия:** 1.0 
**Статус:** Актуально
